name: publish_gui_windows-2019

on:
  # Permit manual trigger
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Manual'
        required: false
        default: ''

env:
  BUILD_TYPE: Release
  BUILD_DIR : build
  VC_VERSION : 16
  COMPILE_VERSION : '"Visual Studio 16 2019"'       # Because cmake -G needs " "
  WX_VERSION : 3.2.2.1
  WX_ROOT : ${{github.workspace}}/wxWidgets-3.2.2.1 # Name of the first folder in wx sources archive
  GLUT_VERSION : 2.8.1-1
  GLUT_ROOT : ${{github.workspace}}/freeglut        # Name of the first folder in freeglut archive
  
jobs:
  build:
    runs-on: windows-2019

    steps:
    - uses: actions/checkout@v3

    # DO NOT Download freeglut 3.0.0 MSVC Package. It is buggy for glutWireCube, glutSolid* !!!
    # Keep freeglut 2.8.1
    - name: Install Freeglut dependency
      run: |
        Invoke-WebRequest https://www.transmissionzero.co.uk/files/software/development/GLUT/older/freeglut-MSVC-${{env.GLUT_VERSION}}.mp.zip -OutFile freeglut.zip
        Expand-Archive freeglut.zip -DestinationPath ${{github.workspace}} # create GLUT_ROOT directory

#    - name: Download last wxWidgets compiled (from publish_wx_windows workflow)
#      id: download-artifact
#      uses: dawidd6/action-download-artifact@v2
#      with:
#        workflow: publish_wx_windows-2019.yml
#        name: windows-2019-${{env.WX_VERSION}}-vc${{env.VC_VERSION}}
#      
#    - name: Install wxWidgets dependency
#      run: |
#        Expand-Archive wxWidgets-${{env.WX_VERSION}}_vc${{env.VC_VERSION}}_x64_release.zip -DestinationPath ${{github.workspace}} # create WX_ROOT directory

    # These wxWidgets binaries for windows are generated by publish_wx_windows-2019.yml
    - name: Install wxWidgets dependency
      run: |
        $WX_ARCHIVE = "wxWidgets-${{env.WX_VERSION}}_vc${{env.VC_VERSION}}_x64_release.zip"
        Invoke-WebRequest https://soft.mines-paristech.fr/wx/$WX_ARCHIVE -OutFile wx.zip
        Expand-Archive wx.zip -DestinationPath ${{github.workspace}} # create WX_ROOT directory

    - name: Create GUI sample program
      run: |
        cmake -B${{env.BUILD_DIR}} -DwxWidgets_ROOT=${{env.WX_ROOT}} -DGLUT_ROOT=${{env.GLUT_ROOT}}
        cmake --build ${{env.BUILD_DIR}} --target package_gui --config ${{env.BUILD_TYPE}}
        $FILE_PATH = Get-ChildItem -Path "${{env.BUILD_DIR}}/${{env.BUILD_TYPE}}/hello*.zip" -File
        echo "MY_FILE=$FILE_PATH" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append

    - uses: actions/upload-artifact@v3
      with:
        name: windows-archive
        path: ${{env.MY_FILE}}

  publish:
    needs: build
    # Only ubuntu can upload via ssh
    runs-on: ubuntu-latest
    
    steps:
    - uses: fabien-ors/files-publish-action@v1
      with:
        host: ${{ secrets.CG_HOST }}
        username: ${{ secrets.CG_USR }}
        password: ${{ secrets.CG_PWD }}
        dest-path: "/var/www/html/wxgl"

